<%= javascript_tag do %>
  window.sprite_sheet_params = {
    "terrain_spritesheet": {
      images: [ "./terrain.png" ],
      frames: { width:32, height: 32 },
      animations: {}
    }
  };

  window.terrain_config = {
    tile_width: <%= @tile_width_in_pixels %>,
    tile_height: <%= @tile_height_in_pixels %>,
    width: <%= @width_in_tiles %>,
    height: <%= @height_in_tiles %>
  };

  window.terrain_tilesets = [
    <% @tilesets.each do |tileset| %>
      {
        firstgid: <%= tileset[0] %>,
        image: <%= tileset[1].to_json.html_safe %>
      },
    <% end %>
      {}
  ];
  window.terrain_tilesets.pop();  // Remove final empty entry

  window.terrain_layers = [
    <% @tile_layers.each do |layer| %>
      {
        name: <%= layer[0].to_json.html_safe %>,
        data: <%= layer[1].to_json.html_safe %>
      },
    <% end %>
      {}
  ];
  window.terrain_layers.pop();  // Remove final empty entry

  window.humanoids = [
    new Humanoid("skeleton1",
      {
        direction: "down",
        action: "walk",
        x: 100, y:50,
        animation_stack: ["skeleton", "robe_male", "kettle_hat_male"]
      }),
    new Humanoid("skeleton2",
      {
        direction: "left",
        action: "slash",
        x: 300, y:100,
        animation_stack: ["skeleton", "chain_armor_female", "plate_shoulder_pad_male", "leather_bracers_male"]
      })
  ]

  // Call init_graphics on page loaded
  $(window.init_graphics);

  window.on_cjs_init = function() {
    window.terrain_tilesheet.set_sprites( <%= @tile_data.inspect %> );

    // Instantiate all humanoid animations
    Humanoid.init_with_stage(window.stage);
  }

  window.on_cjs_tick = function() {
  };
<% end %>

<div id="loader" class="loader"></div>

<h1>Map View</h1>

<canvas id="displayCanvas" width="<%= @width_in_tiles * @tile_width_in_pixels %>"
        height="<%= @height_in_tiles * @tile_height_in_pixels %>"></canvas>
